name: ğŸªŸ Build & Release Flutter Windows App

on:
  push:
    tags:
      - 'v*'         # å½“ä½ æ‰“ tag æ—¶è‡ªåŠ¨å‘å¸ƒï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:  # ä¹Ÿå¯æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest

    steps:
      # -------------------------------
      # 1ï¸âƒ£ æ‹‰å–é¡¹ç›®æºç 
      # -------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2ï¸âƒ£ å®‰è£…æœ€æ–°ç¨³å®šç‰ˆ Flutter
      # -------------------------------
      - name: Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # -------------------------------
      # 3ï¸âƒ£ ç¼“å­˜ Flutter æ„å»ºä¾èµ–
      # -------------------------------
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ./flutter_app/.dart_tool
            ./flutter_app/build
          key: ${{ runner.os }}-flutter-${{ hashFiles('flutter_app/pubspec.lock') }}

      # -------------------------------
      # 4ï¸âƒ£ å¯ç”¨ Windows æ„å»º
      # -------------------------------
      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop
        working-directory: ./flutter_app

      # -------------------------------
      # 5ï¸âƒ£ è·å–ä¾èµ–
      # -------------------------------
      - name: Get Dependencies
        run: flutter pub get
        working-directory: ./flutter_app

      # -------------------------------
      # 6ï¸âƒ£ ç¼–è¯‘ Windows Release
      # -------------------------------
      - name: Build Windows Release
        run: flutter build windows --release
        working-directory: ./flutter_app

      # -------------------------------
      # 7ï¸âƒ£ æ‰“åŒ…æˆ ZIP
      # -------------------------------
      - name: Create ZIP Package
        run: |
          powershell Compress-Archive -Path flutter_app/build/windows/x64/runner/Release/* -DestinationPath 5700webui-server_windows_release.zip

      # -------------------------------
      # 8ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä¾› Actions ä¸‹è½½ï¼‰
      # -------------------------------
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: 5700webui-server-windows
          path: 5700webui-server_windows_release.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      # -------------------------------
      # 9ï¸âƒ£ ä¸‹è½½ä¸Šä¸€æ­¥æ‰“åŒ…å¥½çš„æ–‡ä»¶
      # -------------------------------
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: 5700webui-server-windows
          path: ./release_files

      # -------------------------------
      # ğŸ”Ÿ è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Release
      # -------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./release_files/5700webui-server_windows_release.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
